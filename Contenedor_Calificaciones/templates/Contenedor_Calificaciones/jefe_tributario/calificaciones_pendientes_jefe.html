{% extends 'Contenedor_Calificaciones/base_jefe.html' %}
{% load static %}

{% block title %}Calificaciones Por Aprobar - Jefe{% endblock %}

{% block content %}
<section class="seccion d-flex flex-column justify-content-start align-items-center p-4">
  <div class="container-fluid">
    <div class="row mb-4">
      <div class="col-12">
        <h2 class="fw-bold" style="color:#f5732c;">
          <i class="bi bi-hourglass-split"></i> Calificaciones Por Aprobar de tu Equipo
        </h2>
        <p class="text-muted">Solo se muestran calificaciones en estado <strong>por aprobar</strong> creadas por los calificadores de tu equipo.</p>
        <form method="get" class="row g-2 align-items-end mt-2">
          <div class="col-sm-6 col-md-4">
            <label for="calificador_id" class="form-label">Calificador</label>
            <select id="calificador_id" name="calificador_id" class="form-select">
              <option value="">Todos</option>
              {% for cal in calificadores_equipo %}
                <option value="{{ cal.cuenta_id }}" {% if calificador_seleccionado == cal.cuenta_id|stringformat:'s' %}selected{% endif %}>
                  {{ cal.nombre }} {{ cal.apellido }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-sm-6 col-md-3">
            <label for="page_size" class="form-label">Máximo por página</label>
            <select id="page_size" name="page_size" class="form-select">
              <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
              <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
              <option value="30" {% if page_size == 30 %}selected{% endif %}>30</option>
              <option value="40" {% if page_size == 40 %}selected{% endif %}>40</option>
              <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a href="{% url 'calificaciones_pendientes_jefe' %}" class="btn btn-outline-secondary">Limpiar</a>
          </div>
        </form>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% if calificaciones %}
      <div class="mb-3 text-muted">Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ paginator.count }}</div>
      
      <div class="row row-cols-1 row-cols-lg-2 row-cols-xl-3 g-4">
        {% for c in calificaciones %}
          <div class="col">
            <div class="card h-100 calificacion-jefe-card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <i class="bi bi-file-earmark-text"></i>
                  <strong>Calificación #{{ c.calificacion_id }}</strong>
                </div>
                <span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Por Aprobar</span>
              </div>
              <div class="card-body">
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-building text-primary"></i> Empresa:</span>
                  <strong>{{ c.nombre_empresa|truncatewords:3 }}</strong>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-credit-card text-secondary"></i> RUT:</span>
                  <span>{{ c.rut_empresa.empresa_rut }}</span>
                </div>
                <div class="info-row">
                  <span class="info-label"><i class="bi bi-person-circle" style="color:#f5732c;"></i> Calificador:</span>
                  <span>
                    {% if c.cuenta_id %}
                      {{ c.cuenta_id.nombre }} {{ c.cuenta_id.apellido|slice:":1" }}.
                    {% else %}
                      <span class="text-muted">(desconocido)</span>
                    {% endif %}
                  </span>
                </div>
                <div class="info-row mb-3">
                  <span class="info-label"><i class="bi bi-calendar3 text-info"></i> Fecha:</span>
                  <span>{{ c.fecha_calculo|date:'d/m/Y' }}</span>
                </div>
                <div class="d-grid gap-2">
                  <a href="{% url 'detalle_calificacion_jefe' c.calificacion_id %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-eye"></i> Ver Detalle
                  </a>
                  <div class="btn-group">
                    <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#aprobarModal-{{ c.calificacion_id }}">
                      <i class="bi bi-check2-circle"></i> Aprobar
                    </button>
                    <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rechazarModal-{{ c.calificacion_id }}">
                      <i class="bi bi-x-circle"></i> Rechazar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Aprobar -->
          <div class="modal fade" id="aprobarModal-{{ c.calificacion_id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Aprobar Calificación #{{ c.calificacion_id }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'aprobar_calificacion' c.calificacion_id %}">
                  <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label class="form-label">Observaciones (opcional)</label>
                      <textarea class="form-control" name="observaciones" rows="4" placeholder="Escribe tus observaciones de aprobación..."></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Enviar Aprobación</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Modal Rechazar -->
          <div class="modal fade" id="rechazarModal-{{ c.calificacion_id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Rechazar Calificación #{{ c.calificacion_id }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" action="{% url 'rechazar_calificacion' c.calificacion_id %}">
                  <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                      <label class="form-label">Observaciones (recomendado)</label>
                      <textarea class="form-control" name="observaciones" rows="4" placeholder="Explica el motivo del rechazo..."></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Enviar Rechazo</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <nav aria-label="Paginación" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}{% if calificador_seleccionado %}&calificador_id={{ calificador_seleccionado }}{% endif %}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ paginator.num_pages }}</span></li>
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&page_size={{ page_size }}{% if calificador_seleccionado %}&calificador_id={{ calificador_seleccionado }}{% endif %}">Siguiente</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
          {% endif %}
        </ul>
      </nav>
    {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
        <h4>No hay calificaciones por aprobar</h4>
        <p>Los calificadores de tu equipo no tienen calificaciones en estado por aprobar.</p>
      </div>
    {% endif %}

    <div class="mt-3">
      <a href="{% url 'Inicio_Jefe' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Volver al inicio</a>
    </div>
  </div>
</section>

<style>
.calificacion-jefe-card {
    transition: all 0.3s ease;
    border: 2px solid #e0e0e0;
    background: white;
}

.calificacion-jefe-card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 8px 24px rgba(245, 115, 44, 0.15);
    border-color: #f5732c;
}

.calificacion-jefe-card .card-header {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    color: #333;
    font-weight: 600;
    border-bottom: 2px solid #e0e0e0;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.info-row:last-of-type {
    border-bottom: none;
}

.info-label {
    color: #6c757d;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
}

.btn-outline-primary,
.btn-outline-success,
.btn-outline-danger {
    color: #ffffff !important;
}

.btn-outline-primary:hover,
.btn-outline-success:hover,
.btn-outline-danger:hover {
    color: white !important;
}

</style>

{% endblock %}