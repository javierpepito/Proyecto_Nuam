{% extends 'Contenedor_Calificaciones/base_jefe.html' %}
{% load static %}

{% block title %}Calificaciones Rechazadas - Jefe{% endblock %}

{% block content %}
<section class="seccion d-flex flex-column justify-content-start align-items-center p-4">
  <div class="container-fluid">
    <div class="row mb-4">
      <div class="col-12">
        <h2 class="fw-bold" style="color:#dc3545;">
          <i class="bi bi-x-circle"></i> Calificaciones Rechazadas de tu Equipo
        </h2>
        <p class="text-muted">Se muestran calificaciones en estado <strong>rechazado</strong> creadas por los calificadores de tu equipo.</p>
        <form method="get" class="row g-2 align-items-end mt-2">
          <div class="col-sm-6 col-md-4">
            <label for="calificador_id" class="form-label">Calificador</label>
            <select id="calificador_id" name="calificador_id" class="form-select">
              <option value="">Todos</option>
              {% for cal in calificadores_equipo %}
                <option value="{{ cal.cuenta_id }}" {% if calificador_seleccionado == cal.cuenta_id|stringformat:'s' %}selected{% endif %}>
                  {% if cal.nombre or cal.apellido %}{{ cal.nombre }} {{ cal.apellido }}{% else %}(desconocido){% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-sm-6 col-md-3">
            <label for="page_size" class="form-label">Máximo por página</label>
            <select id="page_size" name="page_size" class="form-select">
              <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
              <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
              <option value="30" {% if page_size == 30 %}selected{% endif %}>30</option>
              <option value="40" {% if page_size == 40 %}selected{% endif %}>40</option>
              <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
            </select>
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary">Filtrar</button>
            <a href="{% url 'calificaciones_rechazadas_jefe' %}" class="btn btn-outline-secondary">Limpiar</a>
          </div>
        </form>
      </div>
    </div>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    {% if calificaciones %}
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted">Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ paginator.count }}</div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center">ID</th>
              <th>Empresa</th>
              <th>Calificador</th>
              <th class="text-center">Fecha</th>
              <th class="text-center">Estado</th>
              <th class="text-center">Detalle</th>
            </tr>
          </thead>
          <tbody>
            {% for c in calificaciones %}
            <tr>
              <td class="text-center">
                {{ c.calificacion_id }}
              </td>
              <td>
                <div class="fw-semibold">{{ c.nombre_empresa }}</div>
                <div class="text-muted small">{{ c.rut_empresa.empresa_rut }}</div>
              </td>
              <td>
                {% if c.cuenta_id %}
                  {% if c.cuenta_id.nombre or c.cuenta_id.apellido %}{{ c.cuenta_id.nombre }} {{ c.cuenta_id.apellido }}{% else %}(desconocido){% endif %}
                {% else %}
                  <span class="text-muted">(desconocido)</span>
                {% endif %}
              </td>
              <td class="text-center">{{ c.fecha_calculo|date:'Y-m-d H:i' }}</td>
              <td class="text-center"><span class="badge bg-danger">Rechazado</span></td>
              <td class="text-center">
                <a class="btn btn-outline-danger btn-sm" href="{% url 'detalle_calificacion_jefe' c.calificacion_id %}">
                  Ver detalle
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav aria-label="Paginación">
        <ul class="pagination justify-content-center mt-3">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}{% if calificador_seleccionado %}&calificador_id={{ calificador_seleccionado }}{% endif %}">Anterior</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
          {% endif %}
          <li class="page-item disabled"><span class="page-link">Página {{ page_obj.number }} de {{ paginator.num_pages }}</span></li>
          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&page_size={{ page_size }}{% if calificador_seleccionado %}&calificador_id={{ calificador_seleccionado }}{% endif %}">Siguiente</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
          {% endif %}
        </ul>
      </nav>
    {% else %}
      <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-info-circle fs-1 d-block mb-3"></i>
        <h4>No hay calificaciones rechazadas</h4>
        <p>Tu equipo aún no registra calificaciones rechazadas.</p>
      </div>
    {% endif %}

    <div class="mt-3">
      <a href="{% url 'Inicio_Jefe' %}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Volver al inicio</a>
    </div>
  </div>
</section>
{% endblock %}