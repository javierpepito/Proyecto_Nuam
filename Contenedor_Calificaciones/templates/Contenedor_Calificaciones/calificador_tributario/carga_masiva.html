{% extends 'Contenedor_Calificaciones/base_calificador.html' %}
{% load static %}

{% block title %}Carga Masiva - Calificador Tributario{% endblock %}

{% block content %}
<div class="container-fluid py-4 mb-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-orange mb-4">
                <i class="bi bi-upload"></i> Carga de calificaciones tributarias
            </h2>
            
            <!-- Formulario de carga -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="formCargaExcel">
                        {% csrf_token %}
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="file" 
                                           class="form-control form-control-lg" 
                                           id="archivo_excel" 
                                           name="archivo_excel" 
                                           accept=".xlsx,.xls"
                                           required>
                                    <button class="btn btn-orange btn-lg text-white px-4" type="submit">
                                        <i class="bi bi-upload"></i> Cargar Archivo
                                    </button>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Formatos aceptados: .xlsx, .xls (Máximo 10 calificaciones)
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <a href="{% static 'Contenedor_Calificaciones/plantillas/Plantilla_Nuam.xlsx' %}" 
                                    class="btn btn-outline-orange btn-lg" 
                                    download="Plantilla_Carga_Masiva_Nuam.xlsx">
                                    <i class="bi bi-download"></i> Descargar plantilla
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Errores globales -->
            {% if errores_globales %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading">
                    <i class="bi bi-exclamation-triangle-fill"></i> Advertencias del archivo
                </h5>
                <ul class="mb-0">
                    {% for error in errores_globales %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <!-- Resumen de carga -->
            {% if archivo_nombre %}
            <div class="card shadow-sm mb-4 border-orange">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-excel text-success"></i> 
                                <strong>Archivo cargado:</strong> 
                                <span class="text-muted">{{ archivo_nombre }}</span>
                            </h5>
                        </div>
                        <div class="col-md-6">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-box bg-primary-light">
                                        <h3 class="text-primary mb-0">{{ total_registros }}</h3>
                                        <small class="text-muted">Total</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-box bg-success-light">
                                        <h3 class="text-success mb-0">{{ registros_validos }}</h3>
                                        <small class="text-muted">Válidos</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-box bg-danger-light">
                                        <h3 class="text-danger mb-0">{{ registros_con_errores }}</h3>
                                        <small class="text-muted">Con errores</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Tarjetas de datos procesados -->
            {% if datos_procesados %}
            <div class="mb-4">
                <h4 class="text-orange mb-3">
                    <i class="bi bi-card-list"></i> Resumen de la Carga
                </h4>
                
                <div class="cards-container">
                    {% for dato in datos_procesados %}
                    <div class="calificacion-card {% if dato.valido %}card-valid{% else %}card-invalid{% endif %}" 
                         data-fila="{{ dato.fila }}">
                        
                        <!-- Header de la tarjeta -->
                        <div class="card-header-custom">
                            <div class="card-number">{{ forloop.counter }}.</div>
                            <div class="card-status">
                                {% if dato.valido %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Válido
                                    </span>
                                {% else %}
                                    <button type="button" 
                                            class="badge bg-danger border-0" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#errores-{{ forloop.counter }}"
                                            style="cursor: pointer;">
                                        <i class="bi bi-exclamation-triangle"></i> Error ({{ dato.errores|length }})
                                    </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Errores (colapsable) -->
                        {% if not dato.valido %}
                        <div class="collapse error-section" id="errores-{{ forloop.counter }}">
                            <div class="alert alert-danger mb-3">
                                <strong><i class="bi bi-x-circle"></i> Errores encontrados:</strong>
                                <ul class="mb-0 mt-2">
                                    {% for error in dato.errores %}
                                    <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Contenido de la tarjeta -->
                        <div class="card-body-custom">
                            <div class="row g-2">
                                <!-- Fila 1: RUT y Nombre -->
                                <div class="col-md-6">
                                    <div class="field-group">
                                        <label>RUT Empresa</label>
                                        <div class="badge-orange">{{ dato.rut_empresa }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="field-group">
                                        <label>Nombre Empresa</label>
                                        <div class="badge-orange">{{ dato.nombre_empresa }}</div>
                                    </div>
                                </div>

                                <!-- Fila 2: Año y Tipo -->
                                <div class="col-md-6">
                                    <div class="field-group">
                                        <label>Año Tributario</label>
                                        <div class="badge-orange">{{ dato.anio_tributario|default:"-" }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="field-group">
                                        <label>Tipo de Calificación</label>
                                        <div class="badge-orange">{{ dato.tipo_calificacion }}</div>
                                    </div>
                                </div>

                                <!-- Fila 3: Monto, Factor, Unidad -->
                                <div class="col-md-4">
                                    <div class="field-group">
                                        <label>Monto Tributario</label>
                                        <div class="badge-orange">{{ dato.monto_tributario|floatformat:2|default:"-" }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="field-group">
                                        <label>Factor Tributario</label>
                                        <div class="badge-orange">{{ dato.factor_tributario|floatformat:2|default:"-" }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="field-group">
                                        <label>Unidad de Valor</label>
                                        <div class="badge-orange">{{ dato.unidad_valor }}</div>
                                    </div>
                                </div>

                                <!-- Fila 4: Puntaje, Categoría, Riesgo -->
                                <div class="col-md-4">
                                    <div class="field-group">
                                        <label>Puntaje</label>
                                        <div class="badge-orange">{{ dato.puntaje_calificacion|default:"-" }}</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="field-group">
                                        <label>Categoría</label>
                                        {% if dato.categoria_calificacion %}
                                            <div class="badge-orange">{{ dato.categoria_calificacion|upper }}</div>
                                        {% else %}
                                            <div class="badge-orange">-</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="field-group">
                                        <label>Nivel de Riesgo</label>
                                        {% if dato.nivel_riesgo %}
                                            {% if dato.nivel_riesgo == 'bajo' %}
                                                <div class="badge bg-success">BAJO</div>
                                            {% elif dato.nivel_riesgo == 'medio' %}
                                                <div class="badge bg-warning text-dark">MEDIO</div>
                                            {% elif dato.nivel_riesgo == 'alto' %}
                                                <div class="badge bg-danger">ALTO</div>
                                            {% elif dato.nivel_riesgo == 'critico' %}
                                                <div class="badge bg-dark">CRÍTICO</div>
                                            {% endif %}
                                        {% else %}
                                            <div class="badge-orange">-</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Fila 5: Observaciones -->
                                <div class="col-12">
                                    <div class="field-group">
                                        <label>Observaciones</label>
                                        <div class="observaciones-box">
                                            {{ dato.justificacion_resultado|default:"Sin observaciones" }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Botones de acción -->
            {% if registros_validos > 0 %}
            <div class="card shadow-sm border-actions mb-5">
                <div class="card-body py-4">
                    <div class="text-center mb-4">
                        <h5 class="text-dark">
                            <i class="bi bi-question-circle"></i> 
                            ¿Qué deseas hacer con las <strong class="text-orange">{{ registros_validos }}</strong> calificaciones válidas?
                        </h5>
                    </div>
                    <div class="row justify-content-center g-3">
                        <div class="col-md-4">
                            <form method="post" action="{% url 'guardar_calificaciones_masivas' %}">
                                {% csrf_token %}
                                <input type="hidden" name="datos_json" value='{{ datos_json }}'>
                                <input type="hidden" name="accion" value="por_enviar">
                                <button type="submit" class="btn btn-warning-custom btn-lg w-100">
                                    <i class="bi bi-pause-circle"></i> Dejar en Pendiente
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Podrás editarlas después</small>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <form method="post" action="{% url 'guardar_calificaciones_masivas' %}">
                                {% csrf_token %}
                                <input type="hidden" name="datos_json" value='{{ datos_json }}'>
                                <input type="hidden" name="accion" value="enviar">
                                <button type="submit" class="btn btn-success-custom btn-lg w-100">
                                    <i class="bi bi-send-check"></i> Enviar Calificaciones
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Irán al jefe para revisión</small>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'carga_masiva' %}" class="btn btn-danger-custom btn-lg w-100">
                                <i class="bi bi-x-circle"></i> Cancelar Calificaciones
                            </a>
                            <small class="text-muted d-block mt-2 text-center">Descartar todas las calificaciones</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

        </div>
    </div>
</div>

<style>
    /* COLORES PRINCIPALES */
    .text-orange {
        color: #ff6b35;
    }
    .bg-orange {
        background-color: #ff6b35;
    }
    .border-orange {
        border: 2px solid #ff6b35;
    }
    .border-actions {
        border: 2px solid #6c757d;
    }
    .btn-orange {
        background-color: #ff6b35;
        color: white;
        border: none;
    }
    .btn-orange:hover {
        background-color: #e55a2b;
        color: white;
    }
    .btn-outline-orange {
        border: 2px solid #ff6b35 !important;
        color: #ff6b35 !important;
        background-color: transparent !important;
    }
    .btn-outline-orange:hover {
        background-color: #ff6b35 !important;
        color: white !important;
    }

    /* BOTONES DE ACCIÓN CON CONTRASTE */
    .btn-warning-custom {
        background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
        color: white;
        border: none;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3);
        transition: all 0.3s ease;
    }
    .btn-warning-custom:hover {
        background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(243, 156, 18, 0.4);
    }

    .btn-success-custom {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
        transition: all 0.3s ease;
    }
    .btn-success-custom:hover {
        background: linear-gradient(135deg, #229954 0%, #27ae60 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4);
    }

    .btn-danger-custom {
        background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
        color: white;
        border: none;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
        transition: all 0.3s ease;
    }
    .btn-danger-custom:hover {
        background: linear-gradient(135deg, #a93226 0%, #c0392b 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4);
    }

    /* ESTADÍSTICAS */
    .stat-box {
        padding: 15px;
        border-radius: 10px;
    }
    .bg-primary-light {
        background-color: #e3f2fd;
    }
    .bg-success-light {
        background-color: #e8f5e9;
    }
    .bg-danger-light {
        background-color: #ffebee;
    }

    /* CONTENEDOR DE TARJETAS (MÁS COMPACTO) */
    .cards-container {
        max-height: 500px;
        overflow-y: auto;
        padding: 8px;
        padding-right: 5px;
        margin-right: 15px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        background-color: #f8f9fa;
    }

    /* TARJETA DE CALIFICACIÓN (MÁS COMPACTA) */
    .calificacion-card {
        background: white;
        border-radius: 8px;
        margin-bottom: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        transition: all 0.3s ease;
    }
    .calificacion-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }

    /* Tarjeta válida */
    .card-valid {
        border-left: 4px solid #28a745;
    }

    /* Tarjeta con errores */
    .card-invalid {
        border-left: 4px solid #dc3545;
    }

    /* HEADER DE LA TARJETA (MÁS COMPACTO) */
    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid #f1f1f1;
    }
    .card-number {
        font-size: 18px;
        font-weight: bold;
        color: #ff6b35;
    }
    .card-status .badge {
        font-size: 12px;
        padding: 6px 10px;
    }

    /* SECCIÓN DE ERRORES */
    .error-section {
        padding: 0 12px;
    }
    .error-section .alert {
        margin-top: 8px;
        font-size: 13px;
    }

    /* BODY DE LA TARJETA (MÁS COMPACTO) */
    .card-body-custom {
        padding: 12px;
    }

    /* GRUPOS DE CAMPOS (MÁS COMPACTOS) */
    .field-group {
        margin-bottom: 6px;
    }
    .field-group label {
        display: block;
        font-size: 10px;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 3px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* BADGES NARANJAS (MÁS COMPACTOS) */
    .badge-orange {
        background-color: #ff6b35;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        display: inline-block;
        font-size: 12px;
        font-weight: 500;
        width: 100%;
        text-align: center;
    }

    /* CAJA DE OBSERVACIONES (MÁS COMPACTA) */
    .observaciones-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 8px;
        font-size: 12px;
        color: #495057;
        min-height: 40px;
        line-height: 1.4;
    }

    /* SCROLL PERSONALIZADO */
    .cards-container::-webkit-scrollbar {
        width: 10px;
    }
    .cards-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .cards-container::-webkit-scrollbar-thumb {
        background: #ff6b35;
        border-radius: 10px;
    }
    .cards-container::-webkit-scrollbar-thumb:hover {
        background: #e55a2b;
    }

    /* FIX: ALTURA MÍNIMA PARA EMPUJAR FOOTER */
    .container-fluid.py-4 {
        min-height: calc(100vh - 450px);
        padding-bottom: 50px;
    }

    /* RESPONSIVO */
    @media (max-width: 768px) {
        .card-number {
            font-size: 16px;
        }
        .badge-orange {
            font-size: 11px;
            padding: 4px 8px;
        }
        .field-group label {
            font-size: 9px;
        }
    }
</style>

<script>
    // Activar tooltips de Bootstrap si es necesario
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script> 
{% endblock %}